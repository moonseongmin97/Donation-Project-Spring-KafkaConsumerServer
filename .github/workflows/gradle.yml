name: Java CI/CD with Kafka Support

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build with Gradle
        run: ./gradlew build -x test

      # 1. 서버에 배포 폴더 확인 및 권한 설정
      - name: Prepare Deploy Directory
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: 2222
          script: |
            sudo mkdir -p /var/www/chat-server
            sudo chown -R $USER:$USER /var/www/chat-server
            # 카프카 폴더 권한도 확인 (필요시)
            sudo chown -R $USER:$USER /var/www/kafka

      # 2. JAR 파일 전송
      - name: Copy JAR to Server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: 2222
          source: "build/libs/*.jar"
          target: "/var/www/chat-server"
          strip_components: 2

      # 3. 서비스 재시작 및 카프카 연결 확인
      - name: Restart Service
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          port: 2222
          script: |
            mv /var/www/chat-server/*.jar /var/www/chat-server/chat-server.jar
            sudo systemctl restart donation-chat
            
            # 서비스 상태 및 카프카 포트(9092) 리스닝 확인
            sleep 5
            sudo systemctl status donation-chat --no-pager
            netstat -tlnp | grep 9092 || echo "Warning: Kafka port 9092 is not active!"
